name: Miri

on:
  pull_request:
    paths:
      - 'crates/stator_core/src/gc/**'
      - 'crates/stator_core/src/objects/**'
      - '.github/workflows/miri.yml'
      - 'crates/stator_core/Cargo.toml'
      - 'Cargo.lock'

permissions:
  contents: read

jobs:
  miri:
    name: Miri (unsafe code validation)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust nightly with Miri
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri, rust-src

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-miri-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-miri-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-miri-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-miri-git-

      - name: Set up Miri sysroot
        run: cargo +nightly miri setup

      - name: Run Miri tests – Stacked Borrows (default)
        env:
          MIRIFLAGS: "-Zmiri-preemption-rate=0.1"
        run: cargo +nightly miri test -p stator_core

      - name: Run Miri tests – Tree Borrows
        env:
          MIRIFLAGS: "-Zmiri-tree-borrows -Zmiri-preemption-rate=0.1"
        run: cargo +nightly miri test -p stator_core
